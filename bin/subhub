#!/usr/bin/env node
var argv = require('optimist').argv;
if (argv.h) {
  console.log('Usage: subhub', '\n');
  console.log('Arguments:');
  console.log('  -h Help. You\'re looking at it');
  console.log('  -c Config file [./config.json]');
  console.log('  -p Port to run the http server on [8000]');
  process.exit(-1);
};

var fs = require('fs'),
  _ = require('underscore'),
  express = require('express'),
  subhub = require('../lib/subhub'),
  config = JSON.parse(fs.readFileSync(argv.c || (process.cwd() + '/config.json'))),
  app = express(),
  firehose = new subhub(config);

app.use(firehose.middleware());
app.listen(argv.p || 8000);

firehose.on('data', function(doc) {
  var entries = _(_.flatten([doc.feed.entry]));
  entries.each(function(entry) {
    console.log(entry.title);
  });
});

firehose.subscribe();